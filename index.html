<!DOCTYPE html>
<html lang="en">
	<head>
		<title>Glass Solid Viewer</title>
		<meta charset="utf-8">
		<style>
			body {
				margin: 0px;
				background-color: #000000;
				overflow: hidden;
			}
		</style>
	</head>
	<body>

		<script src = "three.js"></script>
		<script src = "dat.gui.min.js"></script>
		<script src = "shark.poly.js"></script>
		<script src = "shark.coor.js"></script>
		<script src = "enterprise.poly.js"></script>
		<script src = "enterprise.coor.js"></script>
		<script src = "icosahedron.poly.js"></script>
		<script src = "icosahedron.coor.js"></script>
		<script src = "modelLoader.js"></script>
		<script src = "OrbitControls.js"></script>

		<script type="x-shader/x-vertex" id="vertexShader">

			attribute vec3 center;
			varying vec3 vCenter;

			void main() {

				vCenter = center;
				gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );

			}

		</script>

		<script type="x-shader/x-fragment" id="fragmentShader">

			#extension GL_OES_standard_derivatives : enable

			varying vec3 vCenter;

			float edgeFactorTri() {

				vec3 d = fwidth( vCenter.xyz );
				vec3 a3 = smoothstep( vec3( 0.0 ), d * 1.5, vCenter.xyz );
				return min( min( a3.x, a3.y ), a3.z );

			}

			void main() {

				gl_FragColor.rgb = mix( vec3( 1.0 ), vec3( 0.2 ), edgeFactorTri() );
				gl_FragColor.a = 1.0;
			}

		</script>

		<script>
			var models = [[SHARK_POLY, SHARK_COORD], [ENTERPRISE_POLY, ENTERPRISE_COORD], [ICOSAHEDRON_POLY, ICOSAHEDRON_COORD]];
			var model_id = 0;
			var model_poly = models[model_id][0];
			var model_coord = models[model_id][1];
			var reflectionCube;
			var refractionCube;
			var camera, cameraController, scene, renderer;
			var meshTris, meshLines, meshMixed, test, model;
			var floorTexture = THREE.ImageUtils.loadTexture( "checkboard.png" );
			var color = 0xFFFFFF;
			var shade = THREE.SmoothShading;
			
			init();
			renderer.render( scene, camera );

			function init() {

				scene = new THREE.Scene();
				
				camera = new THREE.PerspectiveCamera( 40, window.innerWidth / window.innerHeight, 1, 4000 );
				camera.position.set( 0, 0, 100);
				camera.lookAt(scene.position);

				var size = 150;

				//var geometryLines = new THREE.BoxGeometry( size, size, size );
				//var geometryTris = new THREE.BoxGeometry( size, size, size );

				// wireframe using gl.LINES

				//var materialLines = new THREE.MeshBasicMaterial( { wireframe: true } );

				//meshLines = new THREE.Mesh( geometryLines, materialLines );
				//meshLines.position.x = -150;
				//scene.add( meshLines );

				//

				var vertexShader = document.getElementById( 'vertexShader' ).textContent;
				var fragmentShader = document.getElementById( 'fragmentShader' ).textContent;

				// wireframe using gl.TRIANGLES (interpreted as triangles)

				//var attributesTris = { center: { type: 'v3', boundTo: 'faceVertices', value: [] } };
				//var valuesTris = attributesTris.center.value;

				//setupAttributes( geometryTris, valuesTris );

				//var materialTris = new THREE.ShaderMaterial( { uniforms: {}, attributes: attributesTris, vertexShader: vertexShader, fragmentShader: fragmentShader } );

				//meshTris = new THREE.Mesh( geometryTris, materialTris );
				//meshTris.position.x = 150;
				//scene.add( meshTris );

				// wireframe using gl.TRIANGLES (mixed triangles and quads)
				var light = new THREE.PointLight(0xFFFFFF);
				light.position.set(0, 600, 0);
				scene.add(light);
				
				//var aLight = new THREE.AmbientLight(0xE0FFF0);
				var aLight = new THREE.AmbientLight(0x333333);
				scene.add(aLight);
	
				var m1 = new THREE.Matrix4();
				var m2 = new THREE.Matrix4();
				m1.makeRotationY(45);
				m2.makeRotationZ(-25);
				
				var textures = ["posx.jpg", "negx.jpg", "posy.jpg", "negy.jpg", "posz.jpg", "negz.jpg"];
				
				var materialArray = [];
				for (var i = 0; i < 6; i++)
					materialArray.push( new THREE.MeshBasicMaterial({
						map: THREE.ImageUtils.loadTexture(textures[i]),
						side: THREE.BackSide
					}));
				var skyMaterial = new THREE.MeshFaceMaterial( materialArray );
				
				reflectionCube = THREE.ImageUtils.loadTextureCube( textures, THREE.CubeReflectionMapping);
				reflectionCube.format = THREE.RGBFormat;
				
				refractionCube = THREE.ImageUtils.loadTextureCube( textures, THREE.CubeRefractionMapping);
				refractionCube.format = THREE.RGBFormat;
				
				var skyBoxGeometry = new THREE.BoxGeometry(2000, 2000, 2000, 1, 1, 1);
				var skyBoxMaterial = new THREE.MeshBasicMaterial( {color: 0x9999ff, side: THREE.BackSide, depthWrite: false, depthTest: false} );
				var skyBox = new THREE.Mesh( skyBoxGeometry, skyMaterial );
				scene.add(skyBox);
				scene.fog = new THREE.FogExp2( 0x9999ff, 0.00025 );
				
				var floorGeometry = new THREE.PlaneGeometry(200, 200, 10, 10);
				floorGeometry.applyMatrix(new THREE.Matrix4().makeRotationX(67.5));
				var floorMaterial = new THREE.MeshBasicMaterial({map: floorTexture});
				var floor = new THREE.Mesh(floorGeometry, floorMaterial);
				floor.position.set(0, -30, 0);
				scene.add(floor);

				//var geometry = new THREE.SphereGeometry( size / 2, 32, 16 );
				model = new Model(model_poly, model_coord);
				model.geometry.computeFaceNormals();
				model.geometry.computeVertexNormals();
				var material = new THREE.MeshPhongMaterial({color: color, envMap: refractionCube, refractionRatio: 1.52, combine: THREE.MixOperation, shading: shade, /*reflectivity: 0.5, /*transparent: true, opacity: 0.6, depthTest: false, depthWrite:false*/});
				var material2 = new THREE.MeshPhongMaterial({color: color, envMap: reflectionCube, refractionRatio: 1.52, combine: THREE.MixOperation, shading: shade, reflectivity: 1.0, transparent: true, opacity: 0.2, depthTest: true, depthWrite:true});
				var material3 = new THREE.MeshPhongMaterial({color: color, combine: THREE.MixOperation, shading: shade, transparent: true, opacity: 0.2, depthTest: true, depthWrite:true}); 
				//var material = new THREE.MeshPhongMaterial({color: 0x660066, specular: 0xFFFFFF, transparent: true, envMap: reflectionCube, combine: THREE.MixOperation, reflectivity: 0.6, refractionRatio: 1.52, opacity: 0.4, depthWrite: false, depthTest: false});

				//var attributesMixed = { center: { type: 'v3', boundTo: 'faceVertices', value: [] } };
				//var valuesMixed = attributesMixed.center.value;

				//setupAttributes( mixedGeometry, valuesMixed );

				//var materialMixed = new THREE.ShaderMaterial( { uniforms: {}, attributes: attributesMixed, vertexShader: vertexShader, fragmentShader: fragmentShader } );

				console.log(model.geometry.vertices, model.geometry.faces);
				meshMixed = THREE.SceneUtils.createMultiMaterialObject(model.geometry, [material, material2, material3]);
				scene.add( meshMixed );
				console.log(meshMixed);

				// renderer

				renderer = new THREE.WebGLRenderer( { antialias: true } );
				renderer.setPixelRatio( window.devicePixelRatio );
				renderer.setSize( window.innerWidth, window.innerHeight );
				document.body.appendChild( renderer.domElement );
				
				cameraController = new THREE.OrbitControls(camera, renderer.domElement);
				cameraController.maxDistance = 1500;
				cameraController.addEventListener('change', render);

				// events

				window.addEventListener( 'resize', onWindowResize, false );
				
				//-------------------------------MENU THINGS---------------------------------------------
				gui = new dat.GUI();
				
				parameters = 
				{
					x: 0, y: 0, z: 0,
					rotX: 0, rotY: 0, rotZ: 0,
					scX:1, scY: 1, scZ: 1,
					color:  "#ffffff", // color (change "#" to "0x")
					crystalline: false,
					reset: function() { this.x = 0; this.y = 0; this.z = 0; this.rotX = 0; this.rotY = 0; this.rotZ = 0; this.scX = 1; this.scY = 1; this.scZ = 1; this.color = "#ffffff"; this.crystalline = false; model_reset();   }
				};
			
				
				var folder1 = gui.addFolder('Position');
				var posX = folder1.add( parameters, 'x' ).min(-200).max(200).step(1).listen();
				var posY = folder1.add( parameters, 'y' ).min(-200).max(200).step(1).listen();
				var posZ = folder1.add( parameters, 'z' ).min(-200).max(200).step(1).listen();
				folder1.open();
				
				folder2 = gui.addFolder('Rotation');
				var rotationX = folder2.add(parameters, 'rotX').min(-360).max(360).step(1).listen();
				var rotationY = folder2.add(parameters, 'rotY').min(-360).max(360).step(1).listen();
				var rotationZ = folder2.add(parameters, 'rotZ').min(-360).max(360).step(1).listen();
				folder2.open();
				
				folder3 = gui.addFolder('Scale');
				var scaleX = folder3.add(parameters, 'scX').min(0).max(5).step(1).listen();
				var scaleY = folder3.add(parameters, 'scY').min(0).max(5).step(1).listen();
				var scaleZ = folder3.add(parameters, 'scZ').min(0).max(5).step(1).listen();
				folder3.open();
				var modelColor = gui.addColor( parameters, 'color' ).name('Color').listen();
				
				var crystal = gui.add(parameters, 'crystalline').name('Crystalline').listen();
				
				gui.add( parameters, 'reset' ).name("Reset Parameters");
				
				//---------------------DO THE THINGS HERE--------------------------------
				posX.onChange(function(value) {   meshMixed.position.x = value; render();   });
				posY.onChange(function(value) {   meshMixed.position.y = value; render();   });
				posZ.onChange(function(value) {   meshMixed.position.z = value; render();   });
				
				rotationX.onChange(function(value) {   meshMixed.rotation.x = value*((Math.PI)/180); render();   });
				rotationY.onChange(function(value) {   meshMixed.rotation.y = value*((Math.PI)/180); render();   });
				rotationZ.onChange(function(value) {   meshMixed.rotation.z = value*((Math.PI)/180); render();   });
				
				scaleX.onChange(function(value) {   meshMixed.scale.x = value; render();   });
				scaleY.onChange(function(value) {   meshMixed.scale.y = value; render();   });
				scaleZ.onChange(function(value) {   meshMixed.scale.z = value; render();   });
							
				modelColor.onChange(function(value) {   color = value; var clr = new THREE.Color(color); meshMixed.children[2].material.color = clr; render();   });
				
				crystal.onChange(function(value) {   if(value){shade = THREE.FlatShading; change_shade(1);}else{shade = THREE.SmoothShading; change_shade(2);}   });
				
				gui.open();
				//-------------------------END MENU THINGS----------------------------------------------

			}

			function onWindowResize() {

				camera.aspect = window.innerWidth / window.innerHeight;
				camera.updateProjectionMatrix();

				renderer.setSize( window.innerWidth, window.innerHeight );

			}
			
			function render() {
				renderer.render( scene, camera );
			}
			
			function change_model(i){
				model_id += i;

				if(model_id < 0){
					model_id = models.length-1;
				}
				else if(model_id == models.length){
					model_id = 0;
				}
				model_poly = models[model_id][0];
				model_coord = models[model_id][1];
				scene.remove(meshMixed);
				model = new Model(model_poly, model_coord);
				model.geometry.computeFaceNormals();
				model.geometry.computeVertexNormals();
				var material = new THREE.MeshPhongMaterial({color: color, envMap: refractionCube, refractionRatio: 1.52, combine: THREE.MixOperation, shading: shade, /*reflectivity: 0.5, /*transparent: true, opacity: 0.6, depthTest: false, depthWrite:false*/});
				var material2 = new THREE.MeshPhongMaterial({color: color, envMap: reflectionCube, /*refractionRatio: 1.52,*/ combine: THREE.MixOperation, shading: shade, reflectivity: 1.0, transparent: true, opacity: 0.2, depthTest: true, depthWrite:true});
				var material3 = new THREE.MeshPhongMaterial({color: color, combine: THREE.MixOperation, shading: shade, transparent: true, opacity: 0.2, depthTest: true, depthWrite:true}); 
				//var material = new THREE.MeshPhongMaterial({color: 0x660066, specular: 0xFFFFFF, transparent: true, envMap: reflectionCube, combine: THREE.MixOperation, reflectivity: 0.6, refractionRatio: 1.52, opacity: 0.4, depthWrite: false, depthTest: false});

				//var attributesMixed = { center: { type: 'v3', boundTo: 'faceVertices', value: [] } };
				//var valuesMixed = attributesMixed.center.value;

				//setupAttributes( mixedGeometry, valuesMixed );

				//var materialMixed = new THREE.ShaderMaterial( { uniforms: {}, attributes: attributesMixed, vertexShader: vertexShader, fragmentShader: fragmentShader } );

				meshMixed = THREE.SceneUtils.createMultiMaterialObject(model.geometry, [material, material2, material3]);
				scene.add( meshMixed );
				render();
			}
			
			window.onkeypress = function(e){
				switch(e.charCode) {
					case 49:
						change_model(-1);
						break;
						
					case 50:
						change_model(1);
						break;
				}
			};
			
			function change_shade(){
				meshMixed.children[0].material = (new THREE.MeshPhongMaterial({color: color, envMap: refractionCube, refractionRatio: 1.52, combine: THREE.MixOperation, shading: shade, /*reflectivity: 0.5, /*transparent: true, opacity: 0.6, depthTest: false, depthWrite:false*/}));
				meshMixed.children[1].material = (new THREE.MeshPhongMaterial({color: color, envMap: reflectionCube, /*refractionRatio: 1.52,*/ combine: THREE.MixOperation, shading: shade, reflectivity: 1.0, transparent: true, opacity: 0.2, depthTest: true, depthWrite:true}));
				meshMixed.children[2].material = (new THREE.MeshPhongMaterial({color: color, combine: THREE.MixOperation, shading: shade, transparent: true, opacity: 0.2, depthTest: true, depthWrite:true}));
				render();
			}
			
			function model_reset(){
				meshMixed.scale.x = 1;
				meshMixed.scale.y = 1;
				meshMixed.scale.z = 1;
				meshMixed.position.x = 0;
				meshMixed.position.y = 0;
				meshMixed.position.z = 0;
				meshMixed.rotation.x = 0;
				meshMixed.rotation.y = 0;
				meshMixed.rotation.z = 0;
				color = "0xffffff";
				shade = THREE.SmoothShading;
				change_shade();
				render();
			}

		</script>
	</body>
</html>
